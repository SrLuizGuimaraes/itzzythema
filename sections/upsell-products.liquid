{% comment %}
  Seção de Upsell Dinâmico para Tema Prestige
  Exibe 3 produtos aleatórios excluindo os que já estão no carrinho
{% endcomment %}

{%- liquid
  assign cart_product_ids = cart.items | map: 'product_id'
  assign all_shop_products = all_products
  assign candidate_products = ''

  for product in all_shop_products
    if product.available and product.variants.size > 0
      unless cart_product_ids contains product.id
        if candidate_products == ''
          assign candidate_products = product.handle
        else
          assign candidate_products = candidate_products | append: ',' | append: product.handle
        endif
      endunless
    endif
  endfor

  assign candidate_handles_array = candidate_products | split: ','
  assign max_products_to_display = 3
  assign displayed_products_count = 0
-%}

{% if candidate_handles_array.size > 0 and cart.item_count > 0 %}
<section class="upsell-products-section" data-section-id="{{ section.id }}">
  <div class="upsell-products-container">
    <div class="upsell-header">
      <h3 class="upsell-title">{{ section.settings.title | default: 'Você também pode gostar' }}</h3>
      {% if section.settings.subtitle != blank %}
        <p class="upsell-subtitle">{{ section.settings.subtitle }}</p>
      {% endif %}
    </div>
    
    <div class="upsell-products-grid">
      {%- liquid
        assign random_seed = 'now' | date: '%s' | modulo: 1000
        assign start_index = random_seed | modulo: candidate_handles_array.size
      -%}
      
      {% for i in (0..candidate_handles_array.size) %}
        {%- liquid
          if displayed_products_count >= max_products_to_display
            break
          endif
          
          assign current_index = start_index | plus: i | modulo: candidate_handles_array.size
          assign product_handle = candidate_handles_array[current_index]
          assign upsell_product = all_shop_products | where: 'handle', product_handle | first
        -%}
        
        {% if upsell_product and upsell_product.available %}
          {%- liquid
            assign displayed_products_count = displayed_products_count | plus: 1
          -%}
          <div class="upsell-product-card" data-product-id="{{ upsell_product.id }}">
            <div class="upsell-product-image">
              <a href="{{ upsell_product.url }}" class="upsell-product-link">
                {% if upsell_product.featured_image %}
                  <img 
                    src="{{ upsell_product.featured_image | image_url: width: 300 }}"
                    alt="{{ upsell_product.featured_image.alt | default: upsell_product.title }}"
                    loading="lazy"
                    width="300"
                    height="300"
                  >
                {% else %}
                  <div class="upsell-product-placeholder">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <circle cx="8.5" cy="8.5" r="1.5"/>
                      <polyline points="21,15 16,10 5,21"/>
                    </svg>
                  </div>
                {% endif %}
              </a>
            </div>
            
            <div class="upsell-product-info">
              <h4 class="upsell-product-title">
                <a href="{{ upsell_product.url }}">{{ upsell_product.title }}</a>
              </h4>
              
              <div class="upsell-product-price">
                {% if upsell_product.compare_at_price > upsell_product.price %}
                  <span class="upsell-price-compare">{{ upsell_product.compare_at_price | money }}</span>
                  <span class="upsell-price-current">{{ upsell_product.price | money }}</span>
                {% else %}
                  <span class="upsell-price-current">{{ upsell_product.price | money }}</span>
                {% endif %}
              </div>
              
              {% if upsell_product.variants.size == 1 %}
                <button 
                  type="button" 
                  class="upsell-add-to-cart btn btn-primary"
                  data-variant-id="{{ upsell_product.selected_or_first_available_variant.id }}"
                  data-quantity="1"
                  {% unless upsell_product.selected_or_first_available_variant.available %}disabled{% endunless %}
                >
                  {% if upsell_product.selected_or_first_available_variant.available %}
                    {{ section.settings.button_text | default: 'Adicionar ao Carrinho' }}
                  {% else %}
                    Esgotado
                  {% endif %}
                </button>
              {% else %}
                <a href="{{ upsell_product.url }}" class="upsell-view-product btn btn-secondary">
                  Ver Produto
                </a>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

{% schema %}
{
  "name": "Upsell Products",
  "tag": "section",
  "class": "upsell-products-section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Título",
      "default": "Você também pode gostar"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtítulo",
      "info": "Texto opcional abaixo do título"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Texto do Botão",
      "default": "Adicionar ao Carrinho"
    },
    {
      "type": "header",
      "content": "Configurações de Layout"
    },
    {
      "type": "select",
      "id": "products_per_row",
      "label": "Produtos por linha",
      "options": [
        {
          "value": "2",
          "label": "2"
        },
        {
          "value": "3",
          "label": "3"
        },
        {
          "value": "4",
          "label": "4"
        }
      ],
      "default": "3"
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espaçamento superior",
      "default": 36
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espaçamento inferior",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Upsell Products"
    }
  ]
}
{% endschema %}