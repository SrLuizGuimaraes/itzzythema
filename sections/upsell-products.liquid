{%- liquid
  assign cart_product_ids = cart.items | map: 'product_id'
  assign all_shop_products = collections['all'].products

  assign candidate_products = all_shop_products | where: "available", true
  assign candidate_products = candidate_products | reject: "id", cart_product_ids

  assign max_products_to_display = 3
  assign displayed_products_count = 0

  assign random_seed = 'now' | date: '%s' | modulo: 1000
  assign start_index = random_seed | modulo: candidate_products.size

  assign used_collections = ''
-%}

{% if candidate_products.size > 0 and cart.item_count > 0 %}
<section class="upsell-products-section" data-section-id="{{ section.id }}">
  <div class="upsell-products-container">
    <div class="upsell-header">
      <h3 class="upsell-title">{{ section.settings.title | default: 'Você também pode gostar' }}</h3>
      {% if section.settings.subtitle != blank %}
        <p class="upsell-subtitle">{{ section.settings.subtitle }}</p>
      {% endif %}
    </div>

    <div class="upsell-products-grid">
      {% for i in (0..candidate_products.size) %}
        {%- liquid
          if displayed_products_count >= max_products_to_display
            break
          endif

          assign current_index = start_index | plus: i | modulo: candidate_products.size
          assign upsell_product = candidate_products[current_index]

          if upsell_product
            assign first_collection = upsell_product.collections | first | default: ''
            unless used_collections contains first_collection
              assign used_collections = used_collections | append: ',' | append: first_collection
              assign displayed_products_count = displayed_products_count | plus: 1
            else
              continue
            endunless
          endif
        -%}

        {% if upsell_product %}
          <div class="upsell-product-card" data-product-id="{{ upsell_product.id }}">
            <div class="upsell-product-image">
              <a href="{{ upsell_product.url }}" class="upsell-product-link">
                {% if upsell_product.featured_image %}
                  <img 
                    src="{{ upsell_product.featured_image | image_url: width: 300 }}"
                    alt="{{ upsell_product.featured_image.alt | default: upsell_product.title }}"
                    loading="lazy"
                    width="300"
                    height="300"
                  >
                {% else %}
                  <div class="upsell-product-placeholder">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <circle cx="8.5" cy="8.5" r="1.5"/>
                      <polyline points="21,15 16,10 5,21"/>
                    </svg>
                  </div>
                {% endif %}
              </a>
            </div>

            <div class="upsell-product-info">
              <h4 class="upsell-product-title">
                <a href="{{ upsell_product.url }}">{{ upsell_product.title }}</a>
              </h4>

              <div class="upsell-product-price">
                {% if upsell_product.compare_at_price > upsell_product.price %}
                  <span class="upsell-price-compare">{{ upsell_product.compare_at_price | money }}</span>
                  <span class="upsell-price-current">{{ upsell_product.price | money }}</span>
                {% else %}
                  <span class="upsell-price-current">{{ upsell_product.price | money }}</span>
                {% endif %}
              </div>

              {% if upsell_product.variants.size == 1 %}
                <button 
                  type="button" 
                  class="upsell-add-to-cart btn btn-primary"
                  data-variant-id="{{ upsell_product.selected_or_first_available_variant.id }}"
                  data-quantity="1"
                  {% unless upsell_product.selected_or_first_available_variant.available %}disabled{% endunless %}
                >
                  {% if upsell_product.selected_or_first_available_variant.available %}
                    {{ section.settings.button_text | default: 'Adicionar ao Carrinho' }}
                  {% else %}
                    Esgotado
                  {% endif %}
                </button>
              {% else %}
                <a href="{{ upsell_product.url }}" class="upsell-view-product btn btn-secondary">
                  Ver Produto
                </a>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}
